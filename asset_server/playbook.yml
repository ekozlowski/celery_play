---
- name: vanilla
  hosts: vanilla
  sudo: true

  tasks:
  - name: Install RabbitMQ
    apt: pkg={{ item }} state=present update_cache=yes cache_valid_time=3600
    with_items:
      - rabbitmq-server

  - name: Enable management plugin
    command: rabbitmq-plugins enable rabbitmq_management
    notify: restart rabbit

  - name: install pip
    apt: pkg={{ item }} state=present update_cache=yes cache_valid_time=3600
    with_items:
      - python-pip
      - python-dev

  - name: pip install celery
    pip: name={{ item }} state=present
    with_items:
      - celery
      - flower

  - name: copy tasks.py to deployed machine
    copy:
      src: ./files/tasks.py
      dest: ./tasks.py
      mode: 0777
     
  handlers:
  - name: restart rabbit
    service: 
      name: rabbitmq-server
      state: restarted

